{"version":3,"file":"serializer.js","sourceRoot":"","sources":["../serializer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * ObjectTemplate.toJSONString;\n */\n/**\n * Convert an object to JSON, stripping any recursive object references so they can be\n * reconstituted later\n *\n * @param {unknown} obj unknown\n * @param {unknown} cb unknown\n *\n * @returns {unknown}\n */\nexport function toJSONString(obj, cb?) {\n    var idMap = [];\n\n    try {\n        return JSON.stringify(obj, function a(key, value) {\n            if (key === '__objectTemplate__' || key === 'amorphic') {\n                return null;\n            }\n            if (value && value.__template__ && value.__id__) {\n                if (idMap[value.__id__]) {\n                    value = { __id__: value.__id__.toString() };\n                }\n                else {\n                    idMap[value.__id__.toString()] = value;\n                }\n            }\n\n            if (cb) {\n                return cb(key, value);\n            }\n\n            return value;\n        });\n    }\n    catch (e) {\n        throw e;\n    }\n}\n\nfunction propXfer(prop, pojo, obj) {\n    if (pojo[prop]) {\n        obj[prop] = pojo[prop];\n    }\n}\n\n/**\n * ObjectTemplate.fromPOJO\n */\nexport function fromPOJO(pojo, template, defineProperty?, idMap?, idQualifier?, parent?, prop?, creator?) {\n    function getId(id) {\n        if (typeof (idQualifier) !== 'undefined') {\n            return id + '-' + idQualifier;\n        }\n\n        return id;\n    }\n\n    // For recording back refs\n    if (!idMap) {\n        idMap = {};\n    }\n\n    if (!pojo.__id__) {\n        return;\n    }\n\n    var obj;\n\n    if (creator) {\n        obj = creator(parent, prop, template, idMap[pojo.__id__.toString()], pojo.__transient__);\n\n        if (obj instanceof Array) {\n            obj = obj[0];\n            idMap[obj.__id__.toString()] = obj;\n            return obj;\n        }\n\n        if (typeof (obj) === 'undefined') {\n            return null;\n        }\n\n        if (!obj) {\n            this.noInit = true;\n            obj = new template();\n            this.noInit = false;\n        }\n    }\n    else {\n        obj = this._createEmptyObject(template, getId(pojo.__id__.toString()), defineProperty, pojo.__transient__);\n    }\n\n    idMap[getId(pojo.__id__.toString())] = obj;\n\n    // Go through all the properties and transfer them to newly created object\n    var props = obj.__template__.getProperties();\n\n    for (var propb in pojo) {\n        propb = propb.replace(/^__/, '');\n        var defineProp = props[propb];\n        if (!defineProp)\n            continue;\n        var type = defineProp.type;\n\n        // Because semotus can serialize only the shadow properties we try and restore them\n        var pojoProp = (type && typeof pojo['__' + propb] !== 'undefined') ? '__' + propb : propb;\n\n        if (type && pojo[pojoProp] == null) {\n            obj[propb] = null;\n        }\n        else if (type && typeof (pojo[pojoProp]) !== 'undefined') {\n            if (type == Array && defineProp.of && defineProp.of.isObjectTemplate) { // Array of templated objects\n                var arrayDirections = null;\n\n                if (creator) {\n                    arrayDirections = creator(obj, propb, defineProp.of, idMap[pojo.__id__.toString()], pojo.__transient__);\n                }\n\n                if (typeof (arrayDirections) !== 'undefined') {\n                    obj[propb] = [];\n\n                    for (var ix = 0; ix < pojo[pojoProp].length; ++ix) {\n                        var atype = pojo[pojoProp][ix].__template__ || defineProp.of;\n                        if (pojo[pojoProp][ix]) {\n                            if (pojo[pojoProp][ix].__id__ && idMap[getId(pojo[pojoProp][ix].__id__.toString())]) {\n                                obj[propb][ix] = idMap[getId(pojo[pojoProp][ix].__id__.toString())];\n                            }\n                            else {\n                                obj[propb][ix] = this.fromPOJO(pojo[pojoProp][ix], atype, defineProp, idMap, idQualifier, obj, propb, creator);\n                            }\n                        }\n                        else {\n                            obj[propb][ix] = null;\n                        }\n                    }\n                }\n                else {\n                    obj[propb] = [];\n                }\n            }\n            else if (type.isObjectTemplate) { // Templated objects\n                var otype = pojo[pojoProp].__template__ || type;\n                if (pojo[pojoProp].__id__ && idMap[getId(pojo[pojoProp].__id__.toString())]) {\n                    obj[propb] = idMap[getId(pojo[pojoProp].__id__.toString())];\n                }\n                else {\n                    obj[propb] = this.fromPOJO(pojo[pojoProp], otype, defineProp, idMap, idQualifier, obj, propb, creator);\n                }\n            }\n            else if (type == Date) {\n                if (pojo[pojoProp]) {\n                    obj[propb] = new Date(pojo[pojoProp]);\n                }\n                else {\n                    obj[propb] = null;\n                }\n            }\n            else {\n                obj[propb] = pojo[pojoProp];\n            }\n        }\n    }\n\n    // For the benefit of persistObjectTemplate\n    if (!creator && pojo._id) {\n        obj._id = getId(pojo._id);\n    }\n\n    if (!creator) {\n        propXfer('__changed__', pojo, obj);\n        propXfer('__version__', pojo, obj);\n    }\n\n    propXfer('__toServer__', pojo, obj);\n    propXfer('__toClient__', pojo, obj);\n\n    return obj;\n};\n\n\n/**\n * ObjectTemplate.fromJSON\n */\nexport function fromJSON(str, template, idQualifier) {\n    return this.fromPOJO(JSON.parse(str), template, null, null, idQualifier);\n};\n"]}